2021-02-03 16:07
#выборка #данныеSQL
# Выборка данных таблицы SQL
#### Чем отличается WHERE от HAVING»
```sql
SELECT username, COUNT(*)
FROM table
WHERE username = ‘Anna’
GROUP BY username
HAVING COUNT(*)>1
```
**HAVING** очень похож на **WHERE** - это тоже фильтр. Вы можете написать в **HAVING** name = ‘Anna’, как и в **WHERE**, и ошибки не будет.

`Во-первых`, в **HAVING** и только в нём `можно писать условия по агрегатным функциям (SUM, COUNT, MAX, MIN и т. д.).` То есть если вы хотите сделать что-то вроде COUNT(*) > 10, то это возможно сделать только в **HAVING**.

"Почему бы не оставить только **HAVING**?" - спросите вы. Всё кроется в том, как **SQL Server** выполняет запрос, в каком порядке происходит его разбор и работа с данными. **WHERE** выполняется до формирования групп **GROUP BY**. Это нужно для того, чтобы можно было оперировать как можно меньшим количеством данных и сэкономить ресурсы сервера и время пользователя.

Следующим этапом формируются группы, которые указаны в **GROUP BY**. После того как сформированы группы, можно накладывать условия на результаты агрегатных функций. И тут как раз наступает очередь **HAVING**: выполняются условия, которые вы задали.

Главное отличие **HAVING** от **WHERE** в том, что в **HAVING** можно наложить условия на результаты группировки, потому что порядок исполнения запроса устроен таким образом, что на этапе, когда выполняется **WHERE**, ещё нет групп, а **HAVING** выполняется уже после формирования групп.

```sql
'`Отобразить всю таблицу`'
SELECT * FROM name_table
```
#### Кол-во выводимых строк (`LIMIT`)
```sql
'`Выбрать нужние столбцы, задать Кол-во выводимых строк'
SELECT name_colum, name1_colum FROM name_table;
LIMIT 2						# Кол-во выводимых строк 2 строки
```
#### Выборка отдельных столбцов и присвоение им новых имен
```sql
# присвоение столбцу old_colum нового имени new_colum
SELECT old_colum AS new_colum FROM name_table;
# переименование 2-x столбцов
SELECT old_colum AS new_colum, old_colum2 AS new_colum2 FROM name_table;
# colum == столбец
```
#### WHERE
```sql
SELECT author,
    MIN(price) AS Минимальная_цена, 
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) > 5000 
ORDER BY Минимальная_цена DESC;
```
#### Сознание вычисляемого столбца
```sql
"**Результатом** является таблица, в которую включены все данные из указанных после  `SELECT` столбцов, а также новый столбец, в каждой строке которого вычисляется заданное выражение."
SELECT title, author, price, amount, # берём столбцы указанные после SELECT 
	price * amount AS total  		 # вычесление AS(записываем) в столбец total(создаём его)
FROM book;
```
#### Операторы `BETWEEN, IN`
`BETWEEN` позволяет отобрать данные, относящиеся к некоторому интервалу, включая его границы.
```sql
SELECT title, amount 
FROM book
WHERE amount BETWEEN 5 AND 14; # Выбрать названия и количества тех книг, количество которых от 5 до 14 включительно.
```
`IN`  позволяет выбрать данные, соответствующие значениям из списка.
```sql
SELECT title, price 
FROM book
WHERE author IN ('Булгаков М.А.', 'Достоевский Ф.М.'); # Выбрать названия и цены книг, написанных Булгаковым или Достоевским.
```
#### Оператор `LIKE` - сравнения строк в соответствии с шаблоном
```sql
 %  # поиск строк содеожащих СИМВОЛ указанный ПОСЛЕ %symbol
SELECT * FROM book WHERE author LIKE '%М.%'  
# выполняет поиск и выдает все книги, инициалы авторов которых содержат «М.»

 _ # поиск строк содеожащих Набор СИМВОЛОВ указанный ПРЕД symbol_
 SELECT * FROM book WHERE title LIKE 'Поэм_'
# выполняет поиск и выдает все книги, названия которых либо «_Поэма_», либо «_Поэмы_» и пр.
# поиск по количеству символов
SELECT title FROM book 
WHERE title LIKE "_____" # Вывести название книг, состоящих ровно из 5 букв.

"_%" - сначала идет символ, а за ним любое количество символов;
"%_"- сначала идет любое количество символов, а затем обязательный символ;
"%_%" - сначала идет любое количество символов, потом обязательный символ, а за ним любое количество символов.

SELECT title FROM book 
WHERE   title LIKE "_% и _%" /*отбирает слово И внутри названия */
    OR title LIKE "и _%" 	 /*отбирает слово И в начале названия */
    OR title LIKE "_% и" 	 /*отбирает слово И в конце названия */
    OR title LIKE "и" 		 /* отбирает название, состоящее из одного слова И */
# вывести названия книг, которые состоят ровно из ОДНОГО СОВА, если считать, что слова в названии отделяются друг от друга пробелами	
SELECT title FROM book 
WHERE title NOT LIKE "% %";  # NOT LIKE  в данном случае отберет все названия, в которых нет пробелов  

```
#### Выборка данных с сортировкой
`ORDER BY` после  задаются имена столбцов, после указывается ключевое слово `ASC` (по возрастанию=def) или `DESC` (по убыванию).

```sql
# ЛОГИЧЕСКИЙ ПОРЯДОК ЗАПРОСА:  1.FROM	 2.WHERE	 3.SELECT	 4.ORDER BY
# СИНТАКСИЧЕСКИЙ 			:  1.SELECT	 2.FROM	 	 3.WHERE	 4.ORDER BY
SELECT title, author, price
FROM book
ORDER BY title;
"Аналогичный результат получится при использовании запроса:"
SELECT title, author, price
FROM book
ORDER BY 1;		# обращение к столбцу по НОМЕРУ
# Вывести автора, название и количество книг, в отсортированном в алфавитном порядке по автору и по убыванию количества, для тех книг, цены которых меньше 750 рублей.
SELECT author, title, amount AS Количество # select + переписываем название столбца amount на Количество
FROM book
WHERE price < 750				# где цена меньше 750
ORDER BY author, amount DESC;	# сортируем по автору по возрастанию и количеству по убыванию
"Можно использовать другие варианты записи запроса:"
SELECT author, title, amount AS Количество
FROM book
WHERE price < 750
ORDER BY author, Количество DESC;

SELECT author, title, amount AS Количество
FROM book
WHERE price < 750
ORDER BY 1, 3 DESC;
```
_____________
#### Links
[[SQL]]