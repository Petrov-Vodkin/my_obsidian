2021-03-23 17:17
#sql
# Групповые запросы в SQL
#### Выбор УНИКАЛЬНЫХ элементов столбца
```sql
"	COUNT(столбец)			- количество значений в столбце 
	COUNT(DISTINCT столбец) - количество уникальных значений в столбце"
# спользуется ключевое слово DISTINCT 
SELECT DISTINCT author # Выбрать авторов, книги из таблицы book
FROM book;
#							 аналогичный результат
# GROUP BY группирует данные при выборке, имеющие одинаковые значения в столбце
SELECT  author
FROM book
GROUP BY author;
```
#### Групповые функции SUM и COUNT
```sql
SELECT author, SUM(amount)  # выбераем авторов и cумируем кол-во книг
FROM book
GROUP BY author;			# группируем по автору

# count() посчитать кол-во "повторений" записей в каждой группе(столбце)
SELECT author, COUNT(author), COUNT(amount), COUNT(*)
FROM book
GROUP BY author;
# COUNT(*) —  подсчитывает  все записи, относящиеся к группе, в том числе и со значением NULL;
# COUNT(имя_столбца) — возвращает количество записей конкретного столбца (только NOT NULL), относящихся к группе.
								"ВАЖНО"
# После оператора `GROUP BY` должны перечисляться ВСЕ неагрегированные столбцы (то есть столбцы, к которым не применены групповые функции), указанные после `SELECT`.
```
#### Групповые функции MIN, MAX и AVG
```sql
"MIN   MAX   AVG"
# вычисляют минимальное, максимальное и среднее значение элементов столбца, относящихся к группе.
SELECT author, MIN(price) AS min_price
FROM book
GROUP BY author;
```
#### Выборка данных c вычислением
```sql
# В качестве аргумента групповых функций  SQL может использоваться не только столбец, но и любое допустимое в SQL арифметическое выражение.
SELECT author, ROUND(AVG(price),2) AS Средняя_цена # округление до 2-х знаков средней цены
FROM book
GROUP BY author;
```
#### Вычисления по таблице целиком
```sql
SELECT SUM(amount) AS Количество
FROM book;
```
#### Выборка данных по условию
```sql
# `WHERE` и `HAVING` могут использоваться в одном запросе. При этом необходимо учитывать порядок выполнения  SQL запроса на выборку на сервере:
1.  FROM 2.  WHERE 3.  GROUP BY 4.  HAVING 5.  SELECT 6.  ORDER BY
									"HAVING" # применять вмест&после с GROUP BY
# Найти минимальную и максимальную цену книг всех авторов, общая стоимость книг которых больше 5000. Результат вывести по убыванию минимальной цены.
SELECT author,
    MIN(price) AS Минимальная_цена, 
    MAX(price) AS Максимальная_цена
FROM book
GROUP BY author
HAVING SUM(price * amount) > 5000 
ORDER BY Минимальная_цена DESC;
									"WHERE" # применять без групировки
SELECT ROUND(AVG(price), 2) AS Средняя_цена,
       SUM(price * amount) AS Стоимость
  FROM book
 WHERE amount BETWEEN 5 AND 14;
							"WHERE" 	"HAVING"
SELECT author,
    MIN(price) AS Минимальная_цена,
    MAX(price) AS Максимальная_цена
FROM book
WHERE author <> 'Есенин С.А.'	# НЕ=="<>": не Есенин
GROUP BY author
HAVING SUM(amount) > 10;
```
`GROUP BY` можно указать (работает):
* вычисляемое выражение;
* исходное имя столбца;
* имя результирующего столбца, заданное после(через) AS;
* номер результирующего столбца (как в ORDER BY).
_____________
#### Links
[[SQL]]